From e40ce4a3511e669e761da5f39d81b14e6cdbdeba Mon Sep 17 00:00:00 2001
From: "Adam C. Emerson" <aemerson@redhat.com>
Date: Mon, 11 Jul 2022 11:52:09 -0400
Subject: [PATCH 1/2] rgw: Fix `rgw::sal::Bucket::empty` static method
 signatures

`unique_ptr` overload should take by reference.

Both should be const.

Signed-off-by: Adam C. Emerson <aemerson@redhat.com>
(cherry picked from commit b1d3e6c00674ebf6bde08968789a426d65db73d9)

Conflicts:
	src/rgw/rgw_sal.h
 - `unique_ptr` overload of empty

Fixes: https://tracker.ceph.com/issues/56585
Signed-off-by: Adam C. Emerson <aemerson@redhat.com>
Signed-off-by: Henry Beberman <henry.beberman@microsoft.com>
---
 src/rgw/rgw_sal.h | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

From f0da8c00a849ab739ba2adfa600616ce921a2055 Mon Sep 17 00:00:00 2001
From: "Adam C. Emerson" <aemerson@redhat.com>
Date: Fri, 8 Jul 2022 14:58:16 -0400
Subject: [PATCH 2/2] rgw: Guard against malformed bucket URLs

Misplaced colons can result in radosgw thinking is has a bucket URL
but with no bucket name, leading to a crash later on.

Fixes: https://tracker.ceph.com/issues/55765
Signed-off-by: Adam C. Emerson <aemerson@redhat.com>
(cherry picked from commit 3ee9a3b41a289a926fed8b8927ca2a93b4f120a6)
Fixes: https://tracker.ceph.com/issues/56585
Signed-off-by: Adam C. Emerson <aemerson@redhat.com>
Signed-off-by: Henry Beberman <henry.beberman@microsoft.com>
---
 src/rgw/rgw_common.cc | 5 +++++
 1 file changed, 5 insertions(+)

diff -Naur a/src/rgw/rgw_common.cc b/src/rgw/rgw_common.cc
--- a/src/rgw/rgw_common.cc	2022-07-21 17:28:56.000000000 +0000
+++ b/src/rgw/rgw_common.cc	2024-05-10 22:05:42.398233127 +0000
@@ -1279,6 +1279,11 @@
 
 bool verify_bucket_permission(const DoutPrefixProvider* dpp, struct req_state * const s, const uint64_t op)
 {
+  if (rgw::sal::RGWBucket::empty(s->bucket)) {
+    // request is missing a bucket name
+    return false;
+  }
+
   perm_state_from_req_state ps(s);
 
   return verify_bucket_permission(dpp, 
diff -Naur a/src/rgw/rgw_sal.h b/src/rgw/rgw_sal.h
--- a/src/rgw/rgw_sal.h	2022-07-21 17:28:56.000000000 +0000
+++ b/src/rgw/rgw_sal.h	2024-05-10 19:39:53.094700848 +0000
@@ -280,7 +280,9 @@
       ent.convert(b);
     }
 
-    static bool empty(RGWBucket* b) { return (!b || b->empty()); }
+    static bool empty(const RGWBucket* b) { return (!b || b->empty()); }
+    /** Check if a Bucket unique pointer is empty */
+    static bool empty(const std::unique_ptr<RGWBucket>& b) { return (!b || b->empty()); }
     virtual std::unique_ptr<RGWBucket> clone() = 0;
 
     /* dang - This is temporary, until the API is completed */
