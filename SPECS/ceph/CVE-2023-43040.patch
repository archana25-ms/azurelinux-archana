From 98bfb71cb38899333deb58dd2562037450fd7fa8 Mon Sep 17 00:00:00 2001
From: Joshua Baergen <jbaergen@digitalocean.com>
Date: Wed, 17 May 2023 12:17:09 -0600
Subject: [PATCH] rgw: Fix bucket validation against POST policies

It's possible that user could provide a form part as a part of a POST
object upload that uses 'bucket' as a key; in this case, it was
overriding what was being set in the validation env (which is the real
bucket being modified). The result of this is that a user could actually
upload to any bucket accessible by the specified access key by matching
the bucket in the POST policy in said POST form part.

Fix this simply by setting the bucket to the correct value after the
POST form parts are processed, ignoring the form part above if
specified.

Fixes: https://tracker.ceph.com/issues/63004

Signed-off-by: Joshua Baergen <jbaergen@digitalocean.com>
Signed-off-by: Henry Beberman <henry.beberman@microsoft.com>
diff -Naur a/src/rgw/rgw_rest_s3.cc b/src/rgw/rgw_rest_s3.cc
--- a/src/rgw/rgw_rest_s3.cc	2022-07-21 17:28:56.000000000 +0000
+++ b/src/rgw/rgw_rest_s3.cc	2024-05-17 19:45:54.373135874 +0000
@@ -2661,10 +2661,6 @@
 
   map_qs_metadata(s);
 
-  ldpp_dout(this, 20) << "adding bucket to policy env: " << s->bucket->get_name()
-		    << dendl;
-  env.add_var("bucket", s->bucket->get_name());
-
   bool done;
   do {
     struct post_form_part part;
@@ -2715,6 +2711,10 @@
     env.add_var(part.name, part_str);
   } while (!done);
 
+  ldpp_dout(this, 20) << "adding bucket to policy env: " << s->bucket->get_name()
+		    << dendl;
+  env.add_var("bucket", s->bucket->get_name());
+
   string object_str;
   if (!part_str(parts, "key", &object_str)) {
     err_msg = "Key not specified";
